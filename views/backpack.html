{% extends "layout.html" %}
{% block body %}
<div class="row backpack">
  <div class="span8 column badges">

    <header>
      <div class="title">Badges</div>
      {% if badges.length < 16 %}
      <div class="addendum">Looking a bit bare? <a href="badges!">Earn more badges!</a></div>
      {% endif %}
    </header>

    <div class="collection">
      {% for badge in badges %}
      <div draggable="true"
           class="badge"
           data-id="{{badge.attributes.id}}"
           rel="popover"
           data-content="Description: {{badge.attributes.body.badge.description}}<br>
                         Issuer: {{badge.attributes.body.badge.issuer.name}}"
           data-original-title="{{badge.attributes.body.badge.name}}"
           style="background: url('{{badge.attributes.image_path}}'); background-size: 100% 100%"></div>
      {% endfor %}
    </div>

    <div class="footer">
     <p>badge footer. With toes (also, an <span class="btn">upload</span> button)</p>
    </div>
  </div>

  <div class="span4 column groups">
    <section>
      <header>
        <div class="title">Groups</div>
      </header>

      <ul class="listing">
        {% if groups.length == 0 %}
        <p class="noGroups">You have no groups yet!</p>
        {% endif %}
        {% for group in groups %}
          <li class="group" data-id="{{group.attributes.id}}" data-url="{{group.attributes.url}}"><a class="groupName" href="share/{{group.attributes.url}}/">{{group.attributes.name}}</a></li>
        {% endfor %}
      </ul>

      <button class="create btn">Create New Group</button>

    </section>

    <section>
      <header>
        <div class="title">Tags</div>
      </header>

      <ul>
        <li>Tag</li>
        <li>Another tag</li>
        <li>Lolcat</li>
        <li>Badges</li>
      </ul>
    <section>

  </div>
</div>

<!-- NOTE: for dev only. For deployment, this needs to use the -min.js version, with the templates compiled to file -->
<script src="js/nunjucks-dev.js"></script>
<script>
if(!nunjucks.env) { nunjucks.env = new nunjucks.Environment(new nunjucks.HttpLoader('/js/templates')); }
var env = nunjucks.env;
</script>
<script src="js/underscore.js"></script>
<script src="js/backbone.js"></script>
<script src="js/backbone/group.js"></script>

<!--
  On-page behaviour for groups. Most of the UX code is found in the abovementioned group.js file, instead.
-->
<script>
(function(){

  function setupGroups() {
    document.removeEventListener("DOMContentLoaded", setupGroups, false);

    // "New Group" button handles
    var createButton = $(".groups button.create"),
        creating = false,
        enableButton = function() { creating = false; createButton.fadeIn(); },
        nogroup = $(".noGroups");

    // group-specific Backbone events
    window.on("group-saved", function()      { nogroup.remove();    });
    window.on("group-cancelled", function()  { nogroup.show();      });
    window.on("group-edit-start", function() { createButton.hide(); });
    window.on("group-edit-end", function()   { enableButton();      });

    // Create groups for server-generated groups.
    // This uses the code found in group.js
    $(".groups .listing li").each(function() {
      Group.fromElement(this);
    });

    /**
     * When the create button is clicked, load a
     * "new group" template, and bind save/cancel
     * behaviour to the button/link span.
     */
    createButton.click(function(btn) {
      if(creating) return;
      createButton.hide();
      nogroup.hide();
      creating = true;

      (function(){ 
            // TODO: make collection handle this?
            var newGroup = new Group();
            newGroup.asEditableEntry();
            var $el = newGroup.currentView.$el;
            $(".groups .listing").append($el);

            // cancel simply discards everything done so far
            $el.find(".cancel").click(function() {
              nogroup.show();
              enableButton();
            });

            // save tells the server to save this group,
            // and then converst the group's "new" template 
            // to a normal group listing entry, instead.
            $el.find(".save").click(function() {
              nogroup.remove();
              enableButton();
            });

      }());
    });
  }
  document.addEventListener("DOMContentLoaded", setupGroups, false);

}());
</script>

<!--

============ THE FOLLOWING STILL NEEDS RELOCATING/CLEANUP ===============

-->

<style>

  html {
    background: none;
  }

  body {
    background: #EEE;
  }

  .backpack header {
    width: 100%;
    /* larges font size is 220% */
    height: 2.2em;
  }

  .backpack header .title {
    font-size: 220%;
    font-weight: bold;
  }

  .backpack header .title {
    float: left;
  }

  .backpack header .addendum {
    float: right;
    font-weight: bold;
    line-height: 2.2em;
  }

  .backpack header .addendum a {
    color: black;
    text-decoration: underline;
  }

  .badges .collection {
    background: white;
    border-radius: 15px;
    padding: 10px 0;
    margin: 1em 0;
  }

  .backpack .footer h1 {
    font-size: 200%;
  }

  .badges p {
    font-weight: bold;
    margin: 0;
    padding: 0;
  }

  .badges p+p {
    margin-top: 1em;
  }

  .badges .badge,
  .newGroup .badgeArea .badge {
    padding: 0; /* override */;
    width: 110px;
    margin: 10px 20px;
    border-radius: 100px;
    display: inline-block;
    background: #d6d6d6;
    text-align: center;

    /* TESTING ONLY */
    color: white;
    font-size: 100px;
    line-height: 100px;
  }
  
  .badges .badge {
    height: auto;
    min-height: 110px;
    background-size: 110px 110px !important;
    background-repeat: no-repeat !important;
  }

  .badgeArea .badge {
    height: auto;
    min-height: 80px;
    background-size: 80px 80px !important;
    background-repeat: no-repeat !important;
  }

  .newGroup .badgeArea .badge {
    width: 80px;
    height: auto;
    min-height: 80px;
    background-size: 80px 80px !important;
    background-repeat: no-repeat !important;
    margin: 2px 4px;
  }

  .groups section + section {
    margin-top: 3em;
  }

  .groups ul {
    margin-top: 1em;
    list-style: none;
    margin-left: 0;
  }

  .groups .group a {
    color: black;
    text-decoration: underline;
    font-weight: bold;
  }

  .groups .group.new {
    border: 1px solid black;
    background: white;
    color: black;
    border-radius: 15px;
    padding: 5px;
  }

  .pages {
    text-align: right;
    line-height: 1em;
    padding: 1em;
  }

  .boxed {
    background: white;
    border: 1px solid grey;
    border-radius: 4px;
    width: 25px;
    height: 25px;
    text-align: center;
    cursor: pointer;
  }

  .boxed + .boxed {
    margin-left: 0.2em;
  }

  .boxed.previous,
  .boxed.next {
    background: #999 !important;
    color: white;
  }

  .boxed.previous + .boxed {
    margin-left: 0.7em;
  }
  .boxed + .boxed.next {
    margin-left: 0.7em;
  }

  .boxed:hover {
    background: #CCC !important;
  }

  .boxed.highlight {
    border: 1px solid #444;
    background: #EEE;
  }

  .btn {
    border-radius: 2em;
    padding: 0.5em 1.5em;

  }
  
  /* ------------------ */
  
  .editGroup {
    font-style: italic;
    cursor: pointer;
    color: rgba(0,0,0,0.4);
  }
  
  .group.editable {
  }
  
  .group.editable input {
    width: 100%;
    line-height: 1.5em;
    height: 2em;
    margin: 0.5em 0;
    padding: 0;
    text-indent: 0.5em;
  }

  .group.editable .badgeArea {
    background-color: white;
    border: 1px solid #DDD;
    border-radius: 10px;
    margin: 0 0 0.5em;
    padding: 0.5em;
    min-height: 220px;

    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;    
    color: #666;
    font-weight: bold;
    font-size: 115%;
  }
  
  .group.editable .cancel {
    color: #444;
    text-decoration: underline;
    cursor: pointer;
  }

  .group.editable .editable {
    padding-left: 0.5em;
  }

  .badge.seethrough {
    opacity: 0.5;
  }

  .badge .actions {
    font-size: 12%;
  }
  
  .badge .actions .btn {
    padding: 0px inherit;
    box-shadow: 0 0 15px rgba(127, 127, 127, 0.7);
    font-size: 0.9em;
    opacity: 0.9;
    width: 100%;
    margin-top: 115px;
  }

  .badgeArea .badge .actions .btn {
    margin-top: 85px;
  }
</style>

<script type="text/javascript">
(function(){

  /**
   * THE PAGINATOR
   *
   * Pagination widget that is addPage(target)'d
   * for each element that should be part of a pagination
   * set, returning the widget as DOM fragment when calling
   * finish(). Comes with prev/next controllers
   *
   */
  var Paginator = function() {
    this.size = 0;
    this.curPage = 0;
    this.targets = [];
    this.pages = [];
    this.node = $("<div class='pages'></div>")[0];
  };
  Paginator.prototype = {
    size: 0,
    curPage: 0,
    targets: [],
    pages: [],
    node: null,
    // add a target to the pagination list
    addPage: function(target) {
      var pageNo = this.size++,
          label = this.size;
      this.targets.push(target);
      page = $("<button class='boxed page'>"+label+"</button>").attr('data-page',pageNo)[0];
      this.pages.push(page);
      $(target).hide();
    },
    select: function(pageNo) {
      this.pages[pageNo].click();
    },
    // hook up the paginating behaviour and
    // add the navigation elements
    finish: function() {
      var targets = $(this.targets),
          node = this.node,
          pages = this.pages,
          paginator = this;

      pages.forEach(function(element) {
        var page = $(element);
        page.click(function() {
          $(pages).removeClass("highlight");
          $(targets).hide();
          paginator.curPage = page.attr('data-page');
          $(targets[paginator.curPage]).show();
          page.addClass("highlight");
        });
        node.appendChild(element);
      });

      var initial = node.childNodes[0],
           previous = $("<button class='boxed page previous'>&lt;</button>")[0],
           next = $("<button class='boxed page next'>&gt;</button>")[0];

      $(previous).click(function() {
        if(paginator.curPage>0) {
          paginator.curPage--;
          paginator.select(paginator.curPage);
        }
        return false;
      });

      $(next).click(function() {
        if(paginator.curPage<paginator.size-1) {
          paginator.curPage++;
          paginator.select(paginator.curPage);
        }
        return false;
      });

      node.insertBefore(previous, initial);
      node.appendChild(next);
      this.select(0);
      return this.node;
    },
  };

  // ============================================

  var PAGE_SET_SIZE = 8;

  /**
   * Get the set of on-page badges
   */
  function getBadges() {
    // straight pull, no processing
    return $('.backpack .collection .badge');
  }

  /**
   * Add badges to a collection container
   */
  function addToContainer(container, badges) {
    var paginator = new Paginator(),
        s, set,
        setCount = 1 + ((badges.length/PAGE_SET_SIZE)|0),
        runner = 0, runTotal=0, badge;

    // create sets
    for(s=0; s<setCount; s++) {
      set = $("<div class='set'></div>")[0];
      runTotal = s*PAGE_SET_SIZE;
      for(runner=0; runner<PAGE_SET_SIZE; runner++) {
        badge = badges[runner + runTotal];
        if(!badge) break;
        set.appendChild(badge);
      }
      container.appendChild(set);
      paginator.addPage(set);
    }

    var paginationWidget = paginator.finish();
    if(paginator.size>1) {
      container.appendChild(paginationWidget);
    }
  }

  /**
   * Test pagination
   */
  function test() {
    document.removeEventListener("DOMContentLoaded",test,false);
    var container = $('.badges .collection')[0],
        badges = getBadges();
    addToContainer(container, badges);
  }

  // kickstart
  document.addEventListener("DOMContentLoaded",test,false);


  // ============================================


  /**
    Bootstrap popover detail panels for badges
  **/
  function badgePopOvers() {
    document.removeEventListener("DOMContentLoaded",badgePopOvers,false);
    var badges = $(".badge");
    //  spawn popovers on a 200ms delay
    badges.popover({delay: 200});
    // but kill them off on mouse clicks
    badges.mousedown(function() { $(this).popover('hide'); });
  }
  document.addEventListener("DOMContentLoaded",badgePopOvers,false);
}());
</script>


<!--
<script type="text/disregard">
    /**
     * is this badge already in the new group's badge area?
     */
    var isBadgeInArea = function(dataId) {
      var badgeArea = $('.badgeArea'),
          badgeSelector = ".badge[data-id="+dataId+"]";
      return $(badgeSelector, badgeArea).length>0;
    }

    /**
     * remove a badge from the new group badge area
     */
    var removeFromBadgeArea = function(badgeArea, dataId) {
      var badgeSelector = ".badge[data-id="+dataId+"]";
      $(badgeSelector, badgeArea).remove();
    };
    
    /**
     * add a "remove" button to the badgearea copy of the badge
     */
    var addRemoveButton = function(badgeArea, badge) {
      var dataId = badge.attr("data-id"),
          created = $("<div class='actions'>"
                   + "  <button class='btn removeFromGroup' data-id='"+dataId+"'>Remove</button>"
                   + "</div>");
      $("button",created).click(function(){
        badge.popover('hide');
        removeFromBadgeArea(badgeArea, dataId);
      });
      console.log(badge, created);
      badge.append(created);
    };
    
    /**
     * add a badge to the badge area for a new group
     */
    var addToBadgeArea = function(badgeArea, badge) {
      badge.appendTo(badgeArea).fadeIn().popover({delay: 200});

      // give this badge "remove" drag and drop behaviour
      badge[0].ondragstart = function(e) {
        e.dataTransfer.setData("data-id", this.getAttribute("data-id"));
        badge.addClass("seethrough");
        badge.popover('hide',{delay:0});
      };
      badge[0].ondragend = function(e) {
        var mx = e.clientX, my = e.clientY;
        var bbox = badgeArea[0].getBoundingClientRect();
        if(mx < bbox.left || mx > bbox.right ||  my < bbox.top || my > bbox.bottom) {
          badge.remove();
        } else {
          badge.removeClass("seethrough");
        }
      }

      // kill off instructions. If they're already
      // killed off, this just does nothing.
      $(".instructions",badgeArea).remove();
      addRemoveButton(badgeArea, badge);
    };


    /**
     * add checkboxes to each badge 
     */
    var addBadgePickers = function(badgeArea) {
      $(".badge").each(function(){
        var created = $("<div class='actions'>"
                     + "  <button class='btn addToGroup' data-id='"+$(this).attr("data-id")+"'>Add to Group</button>"
                     + "</div>");
        $("button",created).click(function(){
          // add to the new group
          var dataId = $(this).attr("data-id");
          // check whether we already have this badge
          if(isBadgeInArea(dataId)) {
            return;
          }
          var badgeSelector = ".badges .badge[data-id="+dataId+"]",
              badge = $(badgeSelector);
          badge.popover('hide');
          badge = badge.clone();
          $(".actions",badge).remove();
          addToBadgeArea(badgeArea, badge);
        });
        $(this).append(created);
      });
    };

    /**
     * remove the badge checkboxes
     */
    var removeBadgePickers = function() {
      $(".badge").each(function(){
        $(".actions",this).remove();
      });
    };

    /**
     * setup up badge drop behaviour for
     * drag-and-drop'ing badges onto the
     * new group area.
     */
    var setupBadgeDropping = function(template) {
      var badgeArea = $('.badgeArea',template);

      // make badges droppable on the badgeArea
      $(".badge").each(function(){
        this["oldDragStart"] = this.ondragstart;
        this.ondragstart = function(e) {
          e.dataTransfer.setData("data-id", this.getAttribute("data-id"));
          $(this).popover('hide',{delay:0});
        };
      });

      // required to make ondrop work for the badge area
      badgeArea[0].ondragover = function(e) { e.preventDefault(); };

      // When a badge is dropped, find out which
      // badge is supposed to be added, and clone it
      // into the badge area.
      badgeArea[0].ondrop = function(e) {
        e.preventDefault();

        var dataId = e.dataTransfer.getData("data-id"),
            badgeSelector = ".badge[data-id="+dataId+"]";
            
        // check whether we already have this badge
        if(isBadgeInArea(dataId)) {
          return;
        }

        // we don't, add it to the badge area from the 
        // collection of badges.
        var badge = $(badgeSelector)[0];
        if(!badge) {
          return;
        }
        badge = $(badge.cloneNode());

        // add it to the badge area
        addToBadgeArea(badgeArea, badge);
      };
    }

    /**
     * disable drag-and-drop for badges, for when there
     * is no "new group" to work with.
     */
    var disableBadgeDropping = function(template) {
      $(".badge").each(function(){
        this.ondragstart = this["oldDragStart"];
      });
    }

    /**
     * When the create button is clicked, load a
     * "new group" template, and bind save/cancel
     * behaviour to the button/link span.
     */
    createButton.click(function(btn) {
      if(creating) return;
      createButton.hide();
      var nogroup = $(".noGroups");
      nogroup.hide();
      creating = true;

      var template = loadTemplate();

      setupBadgeDropping(template);
      var badgeArea = $(".badgeArea",template);
      addBadgePickers(badgeArea);

      // cancel simply discards everything done so far
      $(".cancel", template).click(function() {
        var li = $(this).closest("li");
        li.remove();
        enableButton();
        removeBadgePickers();
        disableBadgeDropping();
        nogroup.show();
      });

      // save tells the server to save this group,
      // and then converst the group's "new" template 
      // to a normal group listing entry, instead.
      $(".save", template).click(function() {
        nogroup.remove();

        // make sure we have a group title.
        var input = $(".groupName",template);
        if(input.val().trim() === "") {
          input.focus();
          return;
        }

        // prevent further save/cancel
        $(".editable",template).remove();
        removeBadgePickers();
        disableBadgeDropping();

        // mock save-result        
        var saveResult = {
          id: 123456,
          url: "a1b2c3d4e5f6g7h8i9j0",
          name: template.find("input").val()
        };

        // Pretend to save this group, using
        // a long timeout "callback". This lets
        // us test what happens on a slow
        // connection.
        setTimeout(function(){
          var readOnly = convertToReadOnly(template, saveResult);
          template.replaceWith(readOnly);
          enableButton();
        }, 500);
      });

      loadTemplateInto(template, ".groups .listing");
    });
  }
  document.addEventListener("DOMContentLoaded", init, false);
}());
</script>
-->

{% endblock %}
